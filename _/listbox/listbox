<head><meta charset="utf-8"><title>k.w</title></head>
<link rel='icon' type'image/png' href="k32.png">
<link rel="stylesheet" href="codemirror/codemirror.min.css">
<style>
 html,body{height:100%;margin:0;padding:0;overflow:hidden;display:flex;flex-flow:column;}
 #tags{flex: 0 1 auto;background:#ffffea;font-family:monospace;border:none;border-bottom:1px solid black;}
 #list{flex: 1 1 auto;background:#ffffea;font-family:monospace;border:none;}
 #canv{flex: 1 1 auto;background:#777777;display:none;}
 .CodeMirror{flex: 1 1 auto;background:#ffffea;display:none;}
</style>
<input    id="tags"/>
<select   id="list" multiple></select>
<textarea id="area" wrap="off" spellcheck="false"></textarea>
<canvas   id="canv"/>
<a        id="save"/>
<script src="codemirror/jquery.min.js"></script>
<script src="codemirror/codemirror.min.js"></script>
<script>
var edit=CodeMirror.fromTextArea(area,{})
var ediv=edit.getWrapperElement()
function display(x){[list,canv,ediv].forEach(i=>i.style.display="none");x.style.display="block";if(x==ediv)edit.refresh()}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}};

var path=[""]
var hist=[""];function addhist(x){if(!hist.includes(x))hist.unshift(x)};function gethist(x){if(x)hist.unshift(hist.pop());else hist.push(hist.shift());tags.value=hist[0]}
tags.onkeydown = function(e){var k=e.which;
 if(k==13){var s=tags.value.substring(tags.selectionStart,tags.selectionEnd);
  if(s.length==0){s=tags.value;addhist(s);tags.value=""};
  if(s.length==0)return start()
  EO(" "+s+"\n"+execute(s))
 }
 if(k==38){gethist(false)}if(k==40){gethist(true)} }
tags.ondblclick = function(e){exec(tags.value.substring(tags.selectionStart,tags.selectionEnd).trim())}
canv.tabIndex=100;canv.onkeydown=function(e){if(e.which==27)display(list)}

list.onkeydown = function(e){if(e.which==13){pd(e);browse()}}
list.ondblclick= function(e){pd(e);browse()}

function start(){
 var t=1<<K.I[32];var f=0;var s=8;var u;for(var i=4;i<32;i++){s=2*s;for(var u=K.I[i];u!=0;u=K.I[u>>>2])f+=s}
 EO(ver+" "+String(t-f)+"/"+String(t)) // used/total
}
function load(s){fetch(s).then(r=>{return r.text()}).then(s=>{EO(execute(strip(s)));stag()})}
function strip(s){return s.split("\n\\")[0]}
var prog=decodeURIComponent(window.location.hash.substr(1))

// k.wasm module
var ver = "k.w "
var hlp = ""; fetch('h').then(r=>{return r.text()}).then(s=>{hlp=s;ver+=s.split("\n")[0];EO(ver)})
var src = ""; fetch('s').then(r=>{return r.text()}).then(s=>{src=s})
var EO = function(s) {edit.doc.setValue(s);display(ediv)}
var draw = function(w,h,p) { console.log("draw: nyi") }
var grow = function(x) {var cur=K.exports.mem.buffer.byteLength;if((1<<x)>cur){var a=(1<<x)-cur;K.exports.mem.grow(a>>>16); msl()};return x}
var printc = function(x,y){EO(logg(su(K.C.slice(x,x+y))+"\n"))}
var msl = function(){var b=K.exports.mem.buffer;K.C=new Uint8Array(b);K.U=new Uint32Array(b);K.I=new Int32Array(b);K.F=new Float64Array(b)}
var nn, tp, dx, mk, sc, val, kst, lup, atx, lcat, bak
WebAssembly.instantiateStreaming(fetch('k.wasm'), { "ext": {"sin":Math.sin,"cos":Math.cos,"exp":Math.exp,"log":Math.log,"atan2":Math.atan2,"hypot":Math.hypot,"draw":draw,"grow":grow,"printc":printc} }).then(r=>{
 K=r.instance;msl();K.exports.ini(16);bak=K.C.slice(0)
 nn=K.exports.nn;tp=K.exports.tp;dx=K.exports.dx;mk=K.exports.mk;sc=K.exports.sc;val=K.exports.val;kst=K.exports.kst;lup=K.exports.lup;atx=K.exports.atx;lcat=K.exports.lcat
 if(prog.length>0)load(prog)
});

function execute(x) {var t=x.trim();if(t.length==0)return;if(t==="\\")return hlp;x=ktry(x);return (x<0)?"!":sk(kst(x))}
function us(s) { return new TextEncoder("utf-8").encode(s) }
function su(u) { return (u.length) ? new TextDecoder("utf-8").decode(u) : "" }
function sk(x) { if(tp(x)!=1){dx(x);return""};var n=nn(x);dx(x);return su(K.C.slice(8+x, 8+x+n))}
function lk(s) { return lup(sc(cstr(s)),0) }
function cstr(s) { var u=us(s);var x=mk(1,u.length);K.C.set(u,8+x);return x }
function ktry(s) {
 try     {var x = val(cstr(s)); bak = K.C.slice(0, 1<<K.U[32]);return x}
 catch(e){console.log(e);K.C.set(bak);return -1}}
function trycall(f,x){try{var x=atx(f,x);bak=K.C.slice(0, 1<<K.U[32]);return x}catch{K.C.set(bak);return 0}}

// Exec tag(word) on double click:
// - lookup global var, if:
//  - value: disp value
//  - func: call f[path] (nilad/monad)
function exec(s){disp(ktry("path:,`"+s+";exec[]"))} //if(s.length==0)return;var x=lk(s);if(!x){EO("!"+s);return};disp(call(x));path=[s];stag()}

function disp(x){if(x<0)EO("!");else if(x==0)EO("");else{var t=tp(x);if(t==1)EO(sk(x));if(t==6){LO(x);dx(x)}}}

function stag(){tags.value=sk(trycall(lk("tags"),kpath()))}
function call(x){if(tp(x))return x;return trycall(x,kpath())}
function kpath(){var x=mk(6,0);for(var i=0;i<path.length;i++)x=lcat(x,kj(path[i]));return x}

function LO(x){setList(jk(x))}
// if(s=="draw"){display(draw)}
// if(s=="list"){display(list)}
// if(s=="edit"){display(ediv)}

// Browse(select) nested list/dict or edit selected items
function browse(){var i=Array.from(list.selectedOptions).map(v=>v.index);var n=i.length
 if(n==0){if(list.length==0){logg("todo append-to-empty")};return}
 path.push(i)
 disp()
}


function kj(x){var r=0;switch(typeof(x)){
 case "string": r=sc(cstr(x));                                                         break
 case "number": r=mk(2,1);K.I[2+(r>>>2)]=x;                                            break
 case "object": r=mk(2,x.length);for(var i=0;i<x.length;i++)K.I[2+i+(r>>>2)]=kj(x[i]); break
 return r}}
function jk(x){
 var n=nn(x);var r=[];var atom=function(x){return(x.length==1)?x[0]:x}
 switch(tp(x)){
 case 1:  r=su(K.C.slice(8+x,8+x+n));                           break
 case 6:  x=(8+x)>>>2;for(var i=0;i<n;i++)r.push(jk(K.I[x+i])); break
 default: r="unknown?"+tp(x)
 };       return r
}

function clrList() {var n=list.options.length;for(var i=n-1;i>=0;i--)list.options[i]=null;}
function setList(x){clrList();for(var i=0;i<x.length;i++){var o=document.createElement("option");o.text=x[i];list.add(o)};display(list)}
function logg(x){console.log(x);return x}
</script><body></body></html>